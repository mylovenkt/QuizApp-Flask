{% extends 'layout.html' %}

{% block title %}Chat Rooms{% endblock %}

{% block head %}
<script>
function handleRoomTypeChange(type) {
    document.getElementById('quizSetSelect').style.display = type === 'quiz_discussion' ? 'block' : 'none';
    document.getElementById('questionSelect').style.display = type === 'question_discussion' ? 'block' : 'none';
    document.getElementById('privateRoomSettings').style.display = type === 'private' ? 'block' : 'none';

    // Make passcode required for private rooms
    const passcodeInput = document.getElementById('passcode');
    passcodeInput.required = type === 'private';
}

function createRoom() {
    const createBtn = document.getElementById('createRoomBtn');
    createBtn.disabled = true;
    createBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

    // Validate form
    const roomName = document.getElementById('roomName').value.trim();
    const roomType = document.getElementById('roomType').value;
    const passcode = document.getElementById('passcode').value.trim();

    if (!roomName) {
        alert('Please enter a room name');
        createBtn.disabled = false;
        createBtn.innerHTML = 'Create';
        return;
    }

    if (roomType === 'private') {
        if (!passcode || !/^\d{4,6}$/.test(passcode)) {
            alert('Please enter a valid passcode (4-6 digits)');
            createBtn.disabled = false;
            createBtn.innerHTML = 'Create';
            return;
        }
    }

    const form = document.getElementById('createRoomForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Set is_private for private rooms
    if (data.type === 'private') {
        data.is_private = true;
    }

    fetch('/chat/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/chat/room/${data.room_id}`;
        } else {
            alert('Error creating room: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating room: ' + (error.error || 'Unknown error'));
    })
    .finally(() => {
        createBtn.disabled = false;
        createBtn.innerHTML = 'Create';
    });
}

document.getElementById('isPrivate').addEventListener('change', function() {
    document.getElementById('passcodeInput').style.display = this.checked ? 'block' : 'none';
    document.getElementById('passcode').required = this.checked;
});

let selectedRoomId = null;
const joinModal = new bootstrap.Modal(document.getElementById('joinRoomModal'));
const joinPasscodeInput = document.getElementById('joinPasscode');
const joinRoomBtn = document.getElementById('joinRoomBtn');

function setSelectedRoom(roomId) {
    selectedRoomId = roomId;
    joinPasscodeInput.value = ''; // Clear previous input
}

joinRoomBtn.addEventListener('click', function() {
    const passcode = joinPasscodeInput.value.trim();
    if (!passcode) {
        alert('Please enter a passcode');
        return;
    }

    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Joining...';

    console.log('Sending join request:', {
        room_id: selectedRoomId,
        passcode: passcode
    });

    fetch('/chat/join', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            room_id: selectedRoomId,
            passcode: passcode
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json().then(data => {
            if (!response.ok) {
                throw new Error(data.error || 'Failed to join room');
            }
            return data;
        });
    })
    .then(data => {
        console.log('Join successful:', data);
        window.location.href = `/chat/room/${data.room_id}`;
    })
    .catch(error => {
        console.error('Error joining room:', error);
        alert(error.message || 'Failed to join room');
        this.disabled = false;
        this.innerHTML = 'Join';
    });
});

// Add keypress event for enter key
joinPasscodeInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        joinRoomBtn.click();
    }
});

function deleteRoom(roomId) {
    if (confirm('Are you sure you want to delete this room? This action cannot be undone.')) {
        fetch(`/chat/room/${roomId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => Promise.reject(data));
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error deleting room: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting room: ' + (error.error || 'Unknown error'));
        });
    }
}

function joinRoom(roomId, isPrivate) {
    if (isPrivate) {
        // Show the join modal
        const modal = new bootstrap.Modal(document.getElementById('joinRoomModal'));
        const joinPasscodeInput = document.getElementById('joinPasscode');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        
        // Store room ID for use in join handler
        window.selectedRoomId = roomId;  // Store roomId globally
        
        // Clear previous passcode
        joinPasscodeInput.value = '';
        
        // Show modal
        modal.show();
        
        // Handle join button click
        joinRoomBtn.onclick = function() {
            const passcode = joinPasscodeInput.value.trim();
            if (!passcode) {
                alert('Please enter a passcode');
                return;
            }
            
            // Disable button and show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Joining...';
            
            // Send join request
            fetch('/chat/join', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    room_id: roomId,
                    passcode: passcode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/chat/room/${data.room_id}`;
                } else {
                    alert(data.error || 'Failed to join room');
                    this.disabled = false;
                    this.innerHTML = 'Join';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error joining room');
                this.disabled = false;
                this.innerHTML = 'Join';
            });
        };
        
        // Handle enter key in passcode input
        joinPasscodeInput.onkeypress = function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                joinRoomBtn.click();
            }
        };
    } else {
        // For non-private rooms, join directly
        fetch('/chat/join', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                room_id: roomId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/chat/room/${data.room_id}`;
            } else {
                alert(data.error || 'Failed to join room');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error joining room');
        });
    }
}
</script>
{% endblock %}

{% block styles %}
<style>
.room-card {
    transition: transform 0.2s;
    cursor: pointer;
}
.room-card:hover {
    transform: translateY(-2px);
}
.room-type-badge {
    position: absolute;
    top: 10px;
    right: 10px;
}
.private-room-card {
    cursor: default;
}
.private-room-card .card-body {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.private-room-card .btn {
    align-self: flex-start;
}
.creator-info {
    font-size: 0.9em;
    color: #6c757d;
}
</style>
{% endblock %}

{% block body %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Chat Rooms</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRoomModal">
            <i class="fas fa-plus"></i> Create Room
        </button>
    </div>

    <!-- Room Categories -->
    <div class="row">
        <!-- General Rooms -->
        <div class="col-md-4 mb-4">
            <h4>General Rooms</h4>
            {% for room in general_rooms %}
            <div class="card room-card mb-3">
                <div class="card-body">
                    <span class="badge bg-primary room-type-badge">General</span>
                    <h5 class="card-title">{{ room.name }}</h5>
                    <p class="card-text">
                        <small class="text-muted">
                            {{ room.participants|length }} participants
                        </small>
                    </p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" 
                                onclick="window.location.href='{{ url_for('main.chat_room', room_id=room.id) }}'">
                            <i class="fas fa-sign-in-alt"></i> Enter Room
                        </button>
                        {% if current_user.is_admin or (current_user.id == room.creator_id and room.type != 'private') %}
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteRoom({{ room.id }})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Private Rooms -->
        <div class="col-md-4 mb-4">
            <h4>Private Rooms</h4>
            {% for room in private_rooms %}
            <div class="card room-card mb-3">
                <div class="card-body">
                    <span class="badge bg-danger room-type-badge">Private</span>
                    <h5 class="card-title">{{ room.name }}</h5>
                    <p class="card-text">
                        <small class="text-muted">
                            Created by: {{ room.creator.name }}<br>
                            {{ room.participants|length }} participants
                        </small>
                    </p>
                    <div class="d-flex gap-2">
                        {% if current_user in room.participants %}
                        <button class="btn btn-primary btn-sm" 
                                onclick="window.location.href='{{ url_for('main.chat_room', room_id=room.id) }}'">
                            <i class="fas fa-sign-in-alt"></i> Enter Room
                        </button>
                        {% else %}
                            {% if current_user.is_admin %}
                            <button class="btn btn-primary btn-sm" 
                                    onclick="joinRoom({{ room.id }}, false)">  <!-- Note: false here for admin -->
                                <i class="fas fa-sign-in-alt"></i> Enter Room
                            </button>
                            {% else %}
                            <button class="btn btn-outline-primary btn-sm" 
                                    onclick="joinRoom({{ room.id }}, true)">
                                <i class="fas fa-key"></i> Join with Passcode
                            </button>
                            {% endif %}
                        {% endif %}
                        {% if room.can_delete(current_user) %}
                        <button class="btn btn-danger btn-sm" onclick="deleteRoom({{ room.id }})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Quiz Discussion Rooms -->
        <div class="col-md-4 mb-4">
            <h4>Quiz Discussions</h4>
            {% for room in quiz_rooms %}
            <div class="card room-card mb-3" onclick="window.location.href='{{ url_for('main.chat_room', room_id=room.id) }}'">
                <div class="card-body">
                    <span class="badge bg-success room-type-badge">Quiz</span>
                    <h5 class="card-title">{{ room.name }}</h5>
                    <p class="card-text">
                        {% if room.quiz_set %}
                        <small class="text-muted">
                            Quiz: {{ room.quiz_set.name }}<br>
                            {{ room.participants|length }} participants
                        </small>
                        {% endif %}
                    </p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" 
                                onclick="window.location.href='{{ url_for('main.chat_room', room_id=room.id) }}'">
                            <i class="fas fa-sign-in-alt"></i> Enter Room
                        </button>
                        {% if current_user.is_admin or (current_user.id == room.creator_id and room.type != 'private') %}
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteRoom({{ room.id }})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Question Discussion Rooms -->
        <div class="col-md-4 mb-4">
            <h4>Question Discussions</h4>
            {% for room in question_rooms %}
            <div class="card room-card mb-3" onclick="window.location.href='{{ url_for('main.chat_room', room_id=room.id) }}'">
                <div class="card-body">
                    <span class="badge bg-info room-type-badge">Question</span>
                    <h5 class="card-title">{{ room.name }}</h5>
                    <p class="card-text">
                        {% if room.question %}
                        <small class="text-muted">
                            Question: {{ room.question.question[:50] }}...<br>
                            {{ room.participants|length }} participants
                        </small>
                        {% endif %}
                    </p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" 
                                onclick="window.location.href='{{ url_for('main.chat_room', room_id=room.id) }}'">
                            <i class="fas fa-sign-in-alt"></i> Enter Room
                        </button>
                        {% if current_user.is_admin or (current_user.id == room.creator_id and room.type != 'private') %}
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteRoom({{ room.id }})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Create Room Modal -->
    <div class="modal fade" id="createRoomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Chat Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createRoomForm">
                        <div class="mb-3">
                            <label for="roomName" class="form-label">Room Name</label>
                            <input type="text" class="form-control" id="roomName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="roomType" class="form-label">Room Type</label>
                            <select class="form-select" id="roomType" name="type" onchange="handleRoomTypeChange(this.value)">
                                <option value="general">General Discussion</option>
                                <option value="quiz_discussion">Quiz Discussion</option>
                                <option value="question_discussion">Question Discussion</option>
                                <option value="private">Private Room</option>
                            </select>
                        </div>
                        <div id="quizSetSelect" class="mb-3" style="display: none;">
                            <label for="quizSet" class="form-label">Select Quiz Set</label>
                            <select class="form-select" id="quizSet" name="quiz_set_id">
                                {% for quiz in quiz_sets %}
                                <option value="{{ quiz.id }}">{{ quiz.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="questionSelect" class="mb-3" style="display: none;">
                            <label for="question" class="form-label">Select Question</label>
                            <select class="form-select" id="question" name="question_id">
                                {% for question in questions %}
                                <option value="{{ question.id }}">{{ question.question[:50] }}...</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="privateRoomSettings" class="mb-3" style="display: none;">
                            <label for="passcode" class="form-label">Room Passcode (4-6 digits)</label>
                            <input type="text" class="form-control" id="passcode" name="passcode" 
                                   pattern="[0-9]{4,6}" maxlength="6">
                            <small class="text-muted">
                                This passcode will be required for others to join the room.<br>
                                Only numbers allowed, between 4-6 digits.<br>
                                You can create up to 3 private rooms.
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createRoom()" id="createRoomBtn">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Private Room Modal -->
    <div class="modal fade" id="joinRoomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Join Private Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="joinPasscode" class="form-label">Enter Passcode</label>
                        <input type="text" class="form-control" id="joinPasscode" 
                               pattern="[0-9]{4,6}" maxlength="6" required
                               placeholder="Enter 4-6 digit passcode">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="joinRoomBtn">Join</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables after DOM is loaded
    const joinModal = new bootstrap.Modal(document.getElementById('joinRoomModal'));
    const joinPasscodeInput = document.getElementById('joinPasscode');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    let selectedRoomId = null;

    // Function to set selected room
    window.setSelectedRoom = function(roomId) {
        console.log('Setting selected room:', roomId); // Debug log
        selectedRoomId = roomId;
        joinPasscodeInput.value = ''; // Clear previous input
    };

    // Add click event listener to join button
    joinRoomBtn.addEventListener('click', function() {
        console.log('Join button clicked'); // Debug log
        const passcode = joinPasscodeInput.value.trim();
        if (!passcode) {
            alert('Please enter a passcode');
            return;
        }

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Joining...';

        console.log('Sending join request for room:', selectedRoomId); // Debug log

        fetch('/chat/join', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                room_id: selectedRoomId,
                passcode: passcode
            })
        })
        .then(response => {
            console.log('Received response:', response); // Debug log
            return response.json();
        })
        .then(data => {
            console.log('Processed data:', data); // Debug log
            if (data.success) {
                window.location.href = `/chat/room/${data.room_id}`;
            } else {
                alert('Error joining room: ' + data.error);
                this.disabled = false;
                this.innerHTML = 'Join';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error joining room: ' + error.message);
            this.disabled = false;
            this.innerHTML = 'Join';
        });
    });

    // Add keypress event for enter key
    joinPasscodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            joinRoomBtn.click();
        }
    });
});

// Other existing functions...
</script>
{% endblock %} 