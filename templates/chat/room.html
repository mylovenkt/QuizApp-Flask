{% extends 'layout.html' %}

{% block title %}Chat Room{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/emojionearea@3.4.2/dist/emojionearea.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/emojionearea@3.4.2/dist/emojionearea.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
/* Core layout styles */
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
}

/* Main content container */
.main-content {
    height: calc(100vh - 56px); /* Subtract navbar height */
    display: flex;
    flex-direction: column;
}

.chat-container {
    display: flex;
    height: calc(100vh - 56px); /* Subtract navbar height */
    background: #2b2d31;
    overflow: hidden;
    position: relative;
}

.chat-messages {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #313338;
    position: relative;
    max-width: calc(100% - 200px);
    height: 100%;
}

.messages-list {
    overflow-y: auto;
    padding: 12px 20px;
    height: calc(100% - 70px); /* Account for input area */
    width: 100%;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
    padding-bottom: 70px;
}

/* Message styles */
.message {
    display: flex;
    align-items: start;
    margin-bottom: 0.5rem;
    padding: 2px 16px;
    animation: fadeIn 0.3s ease;
    position: relative;
}

.message:hover {
    background: rgba(255,255,255,0.02);
}

.avatar-wrapper {
    position: relative;
    margin-right: 16px;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.message-content {
    flex: 1;
    padding: 0;
    background: transparent;
    margin-left: 0;
    margin-right: 0;
    max-width: 100%;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.message-author {
    font-weight: 500;
    color: rgb(242, 243, 245);
    font-size: 1em;
}

.message-time {
    font-size: 0.75em;
    color: #a3a6aa;
}

.edited-indicator {
    font-size: 0.75em;
    color: #a3a6aa;
}

.message-text {
    color: #dbdee1;
    word-break: break-word;
    font-size: 1em;
    line-height: 1.375rem;
}

/* Reactions styling */
.quick-reactions {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 4px;
    background: #2b2d31;
    padding: 4px 8px;
    border-radius: 4px;
    opacity: 0;
    transition: opacity 0.2s ease;
    align-items: center;
}

.reaction-separator {
    width: 1px;
    height: 20px;
    background: rgba(255,255,255,0.1);
    margin: 0 4px;
}

.message:hover .quick-reactions {
    opacity: 1;
}

.reaction-btn {
    padding: 2px 6px;
    background: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.reaction-btn:hover {
    background: rgba(255,255,255,0.1);
}

/* Avatar status indicator */
.avatar-status {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 3px solid #313338;
}

.avatar-status.online {
    background-color: #23a559;
}

.avatar-status.offline {
    background-color: #80848e;
}

/* Message attachment styles */
.message-attachment {
    margin-top: 8px;
}

.message-attachment a {
    color: #00a8fc;
    text-decoration: none;
}

.message-attachment a:hover {
    text-decoration: underline;
}

/* Input area styles */
.message-input-container {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px;
    background: #313338;
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 10;
    height: 60px;  /* Fixed height for input area */
}

.message-input-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #383a40;
    border-radius: 6px;
    padding: 0 6px;
    height: 40px;  /* Fixed height */
}

#messageInput {
    flex: 1;
    background: transparent;
    border: none;
    padding: 4px;
    color: #dcddde;
    resize: none;
    min-height: 20px;
    max-height: 100px;
    font-size: 0.875em;
    line-height: 1.4;
}

/* Style the input buttons to be more compact */
.message-input-buttons {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-left: auto;
}

.message-input-buttons .btn-icon {
    padding: 4px 6px;
    font-size: 1em;
    color: #b9bbbe;
    transition: color 0.2s ease;
}

.message-input-buttons .btn-icon:hover {
    color: #dcddde;
}

/* Adjust EmojioneArea styles for better compactness */
.emojionearea.emojionearea-inline {
    display: flex !important;
    align-items: center;
    padding: 0 !important;
    border: none !important;
    background: transparent !important;
}

.emojionearea .emojionearea-editor {
    flex: 1;
    min-height: 20px;
    max-height: 100px;
    padding: 4px 8px;
    font-size: 0.875em;
    line-height: 1.4;
    background: transparent !important;
    color: #dcddde !important;
}

.emojionearea .emojionearea-button {
    display: none !important;
}

/* Move emoji picker to correct position */
.emojionearea .emojionearea-picker.emojionearea-picker-position-top {
    right: 0 !important;
    left: auto !important;
    margin-bottom: 10px;
}

/* Adjust input buttons container */
.message-input-buttons {
    order: 4;
}

/* Make emoji button match other buttons */
.emojionearea .emojionearea-button > div {
    color: #b9bbbe;
    opacity: 1 !important;
}

.emojionearea .emojionearea-button:hover > div {
    color: #dcddde;
}

/* Hide the default emoji button and create our own */
.emojionearea .emojionearea-button > div {
    visibility: hidden;
}

.emojionearea .emojionearea-button::after {
    content: "\f118";  /* Font Awesome smile icon */
    font-family: "Font Awesome 6 Free";
    visibility: visible;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #b9bbbe;
}

.emojionearea .emojionearea-button:hover::after {
    color: #dcddde;
}

/* Update the picker position */
.emojionearea .emojionearea-picker {
    right: 0 !important;
    left: auto !important;
}

.emojionearea .emojionearea-picker.emojionearea-picker-position-top {
    right: 0 !important;
    left: auto !important;
}

/* Participants sidebar */
.participants-sidebar {
    width: 260px;
    background: #2b2d31;
    border-left: 1px solid rgba(255,255,255,0.1);
    padding: 12px;
    overflow-y: auto;  /* Add scrollbar if needed */
    height: 100%;
}

.participants-header {
    margin-bottom: 8px;
    color: #b5bac1;
    font-size: 0.75em;
    text-transform: uppercase;
    font-weight: 600;
    padding: 0 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.participants-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.participant {
    display: flex;
    align-items: center;
    padding: 6px 8px;
    border-radius: 4px;
    transition: background 0.2s;
    cursor: pointer;
}

.participant:hover {
    background: rgba(255,255,255,0.05);
    transform: translateX(4px);
    transition: all 0.2s ease;
}

.participant-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
}

.participant-info {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.participant-name {
    color: #dbdee1;
    font-size: 0.9em;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
}

.creator-badge {
    font-size: 0.65em;
    background: linear-gradient(90deg, #5865f2, #7289da);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    text-transform: uppercase;
    font-weight: 600;
    white-space: nowrap;
    flex-shrink: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.1);
    letter-spacing: 0.5px;
    animation: badgeGlow 2s infinite;
}

/* Add glow animation for the badge */
@keyframes badgeGlow {
    0% { box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    50% { box-shadow: 0 2px 8px rgba(88,101,242,0.4); }
    100% { box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
}

/* Status indicators */
.avatar-wrapper {
    position: relative;
    display: inline-block;
}

.avatar-status {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 3px solid #2b2d31;
}

.avatar-status.online {
    background: #23a559;
}

.avatar-status.offline {
    background: #80848e;
}

/* Online/Offline sections */
.participants-section {
    margin-bottom: 16px;
}

.participants-section-header {
    color: #b5bac1;
    font-size: 0.75em;
    text-transform: uppercase;
    font-weight: 600;
    padding: 0 8px;
    margin-bottom: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* File upload styles - Updated */
.message-attachment {
    margin-top: 8px;
    padding: 8px;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
}

.message-attachment img {
    max-width: 300px;
    max-height: 300px;
    border-radius: 4px;
}

.message-attachment a {
    color: #00b0f4;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

@keyframes highlight {
    0% { color: #b9bbbe; }
    50% { color: #fff; }
    100% { color: #b9bbbe; }
}

.participant {
    transition: all 0.3s ease;
}

/* Message avatar styles */
.message .avatar-wrapper {
    position: relative;
    margin-right: 16px;
}

.message .message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

/* Keep status indicator only for participants */
.participants-sidebar .avatar-status {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 3px solid #313338;
}

.participants-sidebar .avatar-status.online {
    background-color: #23a559;
}

.participants-sidebar .avatar-status.offline {
    background-color: #80848e;
}

.message-actions {
    display: none;
    gap: 4px;
    margin-left: auto;
}

.message:hover .message-actions {
    display: flex;
}

.btn-icon {
    background: transparent;
    border: none;
    padding: 4px 8px;
    color: #b9bbbe;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
}

.btn-icon:hover {
    color: #dcddde;
    background: rgba(255,255,255,0.1);
}

.edit-message {
    color: #00a8fc;
}

.delete-message {
    color: #ed4245;
}

/* Style for edit mode */
.edit-textarea {
    width: 100%;
    min-height: 40px;
    background: #383a40;
    border: none;
    border-radius: 4px;
    padding: 8px;
    color: #dcddde;
    margin: 4px 0;
    resize: vertical;
}

.edit-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.edit-actions button {
    padding: 4px 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 0.875em;
}

.save-edit {
    background: #5865f2;
    color: white;
}

.cancel-edit {
    background: #4f545c;
    color: white;
}

.message-actions-wrapper {
    display: none;
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: #2b2d31;
    padding: 4px;
    border-radius: 4px;
    gap: 4px;
    align-items: center;
}

.message:hover .message-actions-wrapper {
    display: flex;
}

.message-reactions {
    display: flex;
    align-items: center;
    gap: 4px;
    padding-right: 8px;
    border-right: 1px solid rgba(255,255,255,0.1);
}

.add-reaction {
    padding: 4px 8px;
    color: #b9bbbe;
    background: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.add-reaction:hover {
    color: #dcddde;
    background: rgba(255,255,255,0.1);
}

.quick-reactions {
    display: flex;
    gap: 4px;
}

.message-controls {
    display: flex;
    gap: 4px;
    padding-left: 8px;
}

.btn-icon {
    padding: 4px 8px;
    color: #b9bbbe;
    background: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    color: #dcddde;
    background: rgba(255,255,255,0.1);
}

.edit-message {
    color: #00a8fc;
}

.delete-message {
    color: #ed4245;
}

.message {
    position: relative;
}

.message-hover-controls {
    display: none;
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: #2b2d31;
    padding: 4px;
    border-radius: 4px;
    gap: 4px;
    align-items: center;
}

.message:hover .message-hover-controls {
    display: flex;
}

.btn-icon {
    padding: 4px 8px;
    color: #b9bbbe;
    background: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    color: #dcddde;
    background: rgba(255,255,255,0.1);
}

.add-reaction {
    color: #b9bbbe;
}

.edit-message {
    color: #00a8fc;
}

.delete-message {
    color: #ed4245;
}

.message-hover-controls {
    display: none;
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: #2b2d31;
    padding: 4px;
    border-radius: 4px;
    align-items: center;
}

.message:hover .message-hover-controls {
    display: flex;
    gap: 2px;
}

.reactions-group {
    display: flex;
    align-items: center;
    gap: 2px;
    padding-right: 4px;
    border-right: 1px solid rgba(255,255,255,0.1);
}

.active-reactions {
    display: flex;
    gap: 2px;
}

.reaction-count {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: rgba(255,255,255,0.05);
    border: none;
    border-radius: 4px;
    color: #b9bbbe;
    font-size: 0.9em;
    cursor: pointer;
    transition: background 0.2s;
}

.reaction-count:hover {
    background: rgba(255,255,255,0.1);
}

.message-controls {
    display: flex;
    gap: 2px;
    padding-left: 4px;
}

.btn-icon {
    padding: 4px 8px;
    color: #b9bbbe;
    background: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    color: #dcddde;
    background: rgba(255,255,255,0.1);
}

.add-reaction {
    color: #b9bbbe;
}

.edit-message {
    color: #b9bbbe;
}

.delete-message {
    color: #b9bbbe;
}

/* Creator badge styles */
.creator-badge {
    background: linear-gradient(45deg, #5865f2, #8b94ff);
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 6px;
    text-transform: uppercase;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.1);
}

/* Username truncation */
.participant-name {
    max-width: 140px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #dcddde;
}

.reaction-buttons {
    display: flex;
    gap: 2px;
}

.active-reactions {
    display: flex;
    gap: 4px;
    margin-right: 8px;
}

.reaction-count {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    background: rgba(255,255,255,0.05);
    border: none;
    border-radius: 4px;
    color: #b9bbbe;
    font-size: 0.9em;
    cursor: pointer;
    transition: background 0.2s;
}

.reaction-count:hover {
    background: rgba(255,255,255,0.1);
}

.active-reactions {
    display: flex;
    gap: 4px;
    margin-right: 8px;
    min-height: 24px;
}

.reaction-count {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    background: rgba(255,255,255,0.05);
    border: none;
    border-radius: 4px;
    color: #b9bbbe;
    font-size: 0.9em;
    cursor: pointer;
    transition: background 0.2s;
}

.reaction-count:hover {
    background: rgba(255,255,255,0.1);
}

.reaction-buttons {
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.2s;
}

.message:hover .reaction-buttons {
    opacity: 1;
}

/* Update reaction styles */
.message-reactions {
    margin-top: 4px;
}

.active-reactions {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.reaction-count {
    display: flex;
    align-items: center;
    padding: 2px 8px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    color: #dcddde;
    font-size: 0.9em;
    cursor: pointer;
    transition: background 0.2s;
}

.reaction-count:hover {
    background: rgba(255,255,255,0.1);
}

.reaction-buttons {
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.2s;
}

.message:hover .reaction-buttons {
    opacity: 1;
}

.emoji-picker {
    position: absolute;
    bottom: 100%;
    right: 0;
    background: #2b2d31;
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
}

.emoji-picker-content {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 4px;
}

.emoji-option {
    padding: 6px;
    font-size: 1.2em;
    background: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.emoji-option:hover {
    background: rgba(255,255,255,0.1);
}

/* Style for edit/delete buttons */
.message-controls {
    display: flex;
    gap: 4px;
    margin-left: 8px;
}

.message-controls .btn-icon {
    padding: 4px 8px;
    color: #b9bbbe;
}

.message-controls .btn-icon:hover {
    color: #dcddde;
}

.emoji-button {
    padding: 4px 6px;
    font-size: 1em;
    color: #b9bbbe;
    transition: color 0.2s ease;
}

.emoji-button:hover {
    color: #dcddde;
}

/* EmojioneArea customization */
.emojionearea.emojionearea-inline {
    font-size: 0.875em;
    border: none;
    background: transparent;
}

.emojionearea .emojionearea-editor {
    min-height: 20px;
    max-height: 100px;
    color: #dcddde;
    padding: 4px;
}

.emojionearea .emojionearea-button {
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-50%);
}

.message-input-buttons {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-left: auto;
}

.message-input-buttons .btn-icon {
    padding: 4px 6px;
    font-size: 1em;
    color: #b9bbbe;
    transition: color 0.2s ease;
}

.message-input-buttons .btn-icon:hover {
    color: #dcddde;
}

/* Update emoji button styles to match other buttons */
.emoji-button {
    padding: 4px 6px;
    font-size: 1em;
    color: #b9bbbe;
    transition: color 0.2s ease;
}

.emoji-button:hover {
    color: #dcddde;
}

.image-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(5px);
    overflow-y: auto;
    padding: 40px 0;
}

.modal-content {
    position: relative;
    margin: 0 auto;
    padding: 0;
    width: 90%;
    min-height: calc(100vh - 80px);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content img {
    max-width: 100%;
    height: auto;
    object-fit: contain;
    display: block;
    transition: transform 0.3s ease-out;
}

.close-modal {
    position: fixed;
    right: 20px;
    top: 20px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    z-index: 1001;
    text-shadow: 0 0 10px rgba(0,0,0,0.5);
}

.zoom-controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 1001;
}

.zoom-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

.zoom-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.message-attachment img {
    cursor: zoom-in;
    transition: transform 0.2s;
}

.message-attachment img:hover {
    transform: scale(1.02);
}

.message-controls {
    display: flex;
    gap: 4px;
    padding-left: 8px;
    border-left: 1px solid rgba(255,255,255,0.1);
}

.edit-message {
    color: #00a8fc;
}

.delete-message {
    color: #ed4245;
}

.message-controls .btn-icon:hover {
    background: rgba(255,255,255,0.1);
}

.edit-message {
    color: #00a8fc !important;
}

.delete-message {
    color: #ed4245 !important;
}

.quick-reactions .btn-icon {
    padding: 2px 6px;
    background: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.quick-reactions .btn-icon:hover {
    background: rgba(255,255,255,0.1);
}

.edit-container {
    margin: 4px 0;
    background: #383a40;
    border-radius: 4px;
    padding: 8px;
}

.edit-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding: 0 4px;
}

.edit-textarea {
    width: 100%;
    min-height: 40px;
    background: #2b2d31;
    border: none;
    border-radius: 4px;
    padding: 8px;
    color: #dcddde;
    resize: none;
}

.edit-buttons {
    display: flex;
    gap: 8px;
}

.save-edit, .cancel-edit {
    padding: 4px 16px;
    border-radius: 3px;
    border: none;
    cursor: pointer;
    font-size: 0.875em;
    font-weight: 500;
}

.save-edit {
    background: #5865f2;
    color: white;
}

.cancel-edit {
    color: #dcddde;
    background: transparent;
}

.cancel-edit:hover {
    text-decoration: underline;
}

/* Update emoji-only message styles */
.message-text {
    font-size: 1em;
}

/* Style for emoji-only messages */
.message-text.emoji-only {
    font-size: 3em !important;
    line-height: 1.2 !important;
    padding: 4px 0;
    margin: 4px 0;
    display: inline-block;
    transform-origin: left center;
    transition: all 0.3s ease;
}

/* Ensure emojis are rendered at full size */
.message-text.emoji-only img.emojione {
    width: 3em !important;
    height: 3em !important;
}

/* Base message text style */
.message-text {
    transition: all 0.3s ease;
    font-size: 1em;
    line-height: 1.375rem;
}

/* Container for the entire app */
.container-fluid {
    height: 100vh;
    padding: 0;
    margin: 0;
    overflow: hidden;
}

/* Update message list padding */
.messages-list {
    padding-bottom: 70px;  /* Add padding to prevent messages being hidden behind input */
}

/* Update navbar styles to ensure proper height */
.navbar {
    height: 56px;
    z-index: 1030;
}

#total-participants,
#online-count,
#offline-count {
    color: #949ba4;
    font-weight: normal;
}

/* Add these styles to your existing CSS */
.message-attachment img {
    max-width: 300px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.message-attachment img:hover {
    transform: scale(1.02);
}

.uploaded-image {
    max-width: 300px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.uploaded-image:hover {
    transform: scale(1.02);
}

/* Update image attachment styles */
.message-attachment {
    margin-top: 8px;
}

.message-attachment img {
    max-width: 300px;
    border-radius: 4px;
    display: block;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.message-attachment img:hover {
    transform: scale(1.02);
}

.message-attachment .image-container {
    background-color: #2b2d31;
    padding: 8px;
    border-radius: 8px;
}

.message-attachment .file-name {
    margin-top: 8px;
    font-size: 0.9em;
    color: #b9bbbe;
}
</style>
{% endblock %}

{% block body %}
<div class="main-content">
    <div class="chat-container">
        <!-- Messages Area -->
        <div class="chat-messages">
            <div class="messages-list" id="messages">
                {% for message in messages %}
                <div class="message" data-message-id="{{ message.id }}">
                    <div class="avatar-wrapper">
                        <img src="{{ message.user.get_avatar_url }}" 
                             class="message-avatar" 
                             alt="{{ message.user.display_name }}">
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-author">{{ message.user.display_name }}</span>
                            <span class="message-time">
                                {% if message.created_at.date() == now.date() %}
                                    Today at {{ message.created_at|format_datetime('%H:%M') }}
                                {% elif message.created_at.date() == yesterday.date() %}
                                    Yesterday at {{ message.created_at|format_datetime('%H:%M') }}
                                {% else %}
                                    {{ message.created_at|format_datetime('%d/%m/%y %H:%M') }}
                                {% endif %}
                            </span>
                            {% if message.edited_at %}
                                <span class="edited-indicator">(edited)</span>
                            {% endif %}
                        </div>
                        <div class="message-text">{{ message.content }}</div>
                        {% if message.file_url %}
                            <div class="message-attachment">
                                {% if message.file_url.endswith(('.jpg', '.jpeg', '.png', '.gif')) %}
                                    <div style="background-color: #2b2d31; padding: 8px; border-radius: 8px;">
                                        <img src="{{ message.file_url }}" 
                                             alt="{{ message.file_name }}" 
                                             style="max-width: 300px; border-radius: 4px; display: block;" 
                                             class="zoomable-image">
                                        <div style="margin-top: 8px; font-size: 0.9em; color: #b9bbbe;">
                                            {{ message.file_name }}
                                        </div>
                                    </div>
                                {% else %}
                                    <a href="{{ message.file_url }}" target="_blank" download>
                                        <i class="fas fa-file"></i> {{ message.file_name }}
                                    </a>
                                {% endif %}
                            </div>
                        {% endif %}
                        <div class="message-reactions">
                            {% if message.get_reactions() %}
                            <div class="active-reactions">
                                {% for emoji, count in message.get_reactions().items() %}
                                <button class="reaction-count" data-emoji="{{ emoji }}">
                                    {{ emoji }} {{ count }}
                                </button>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="message-hover-controls">
                        <div class="reactions-group">
                            <div class="quick-reactions">
                                <button class="btn-icon reaction-btn" data-emoji="👍" data-message-id="{{ message.id }}" title="Like">👍</button>
                                <button class="btn-icon reaction-btn" data-emoji="❤️" data-message-id="{{ message.id }}" title="Heart">❤️</button>
                                <button class="btn-icon reaction-btn" data-emoji="😄" data-message-id="{{ message.id }}" title="Smile">😄</button>
                                <button class="btn-icon reaction-btn" data-emoji="" data-message-id="{{ message.id }}" title="Wow">😮</button>
                                <button class="btn-icon reaction-btn" data-emoji="😢" data-message-id="{{ message.id }}" title="Sad">😢</button>
                                <button class="btn-icon add-reaction" data-message-id="{{ message.id }}" title="Add Reaction">
                                    <i class="fas fa-plus"></i>
                                </button>
                                {% if message.user_id == current_user.id or current_user.is_admin %}
                                <div class="reaction-separator"></div>
                                <button class="btn-icon edit-message" title="Edit">
                                    <i class="fas fa-pencil"></i>
                                </button>
                                <button class="btn-icon delete-message" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                            <div class="emoji-picker" style="display: none;">
                                <div class="emoji-picker-content">
                                    <button class="emoji-option" data-emoji="😀">😀</button>
                                    <button class="emoji-option" data-emoji="😂">😃</button>
                                    <button class="emoji-option" data-emoji="😄">😄</button>
                                    <button class="emoji-option" data-emoji="😁">😁</button>
                                    <button class="emoji-option" data-emoji="😅">😅</button>
                                    <button class="emoji-option" data-emoji="😂">😂</button>
                                    <button class="emoji-option" data-emoji="🤣">🤣</button>
                                    <button class="emoji-option" data-emoji="😊">😊</button>
                                    <button class="emoji-option" data-emoji="🥰">🥰</button>
                                    <button class="emoji-option" data-emoji="😎">😍</button>
                                    <button class="emoji-option" data-emoji="🤩">🤩</button>
                                    <button class="emoji-option" data-emoji="😘">😘</button>
                                    <button class="emoji-option" data-emoji="💕">💕</button>
                                    <button class="emoji-option" data-emoji="💖">💖</button>
                                    <button class="emoji-option" data-emoji="😎">😎</button>
                                    <button class="emoji-option" data-emoji="🤠">🤠</button>
                                    <button class="emoji-option" data-emoji="😏">😏</button>
                                    <button class="emoji-option" data-emoji="😌">😌</button>
                                    <button class="emoji-option" data-emoji="🤪">🤪</button>
                                    <button class="emoji-option" data-emoji="😜">😜</button>
                                    <button class="emoji-option" data-emoji="🤓">🤓</button>
                                    <button class="emoji-option" data-emoji="🥳">🥳</button>
                                    <button class="emoji-option" data-emoji="🤔">🤔</button>
                                    <button class="emoji-option" data-emoji="🤨">🤨</button>
                                    <button class="emoji-option" data-emoji="😐">😐</button>
                                    <button class="emoji-option" data-emoji="😑">😑</button>
                                    <button class="emoji-option" data-emoji="👋">👋</button>
                                    <button class="emoji-option" data-emoji="🙌">🙌</button>
                                    <button class="emoji-option" data-emoji="👏">👏</button>
                                    <button class="emoji-option" data-emoji="🎉">🎉</button>
                                </div>
                            </div>
                        </div>
                        {% if message.user.id == current_user.id or current_user.is_admin %}
                        <div class="message-controls">
                            <button class="btn-icon edit-message" title="Edit">
                                <i class="fas fa-pencil"></i>
                            </button>
                            <button class="btn-icon delete-message" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Message Input -->
            <div class="message-input-container">
                <div class="message-input-wrapper">
                    <textarea id="messageInput" placeholder="Type a message..."></textarea>
                    <div class="message-input-buttons">
                        <button class="btn-icon custom-emoji-button" title="Add Emoji">
                            <i class="far fa-smile"></i>
                        </button>
                        <input type="file" id="fileInput" style="display: none;" 
                               accept="image/*,.pdf,.doc,.docx,.zip,.rar">
                        <button class="btn-icon" id="attachButton" title="Attach File">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="btn-icon" title="Send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Participants Sidebar -->
        <div class="participants-sidebar">
            <div class="participants-header">
                PARTICIPANTS — <span>{{ participants|length }}</span>
            </div>
            
            <!-- Online Users Section -->
            <div class="participants-section online-section">
                <div class="participants-section-header">
                    ONLINE — <span>{{ online_count }}</span>
                </div>
                <div class="online-users">
                    {% for participant in participants %}
                        {% if participant.is_online %}
                        <div class="participant" data-user-id="{{ participant.id }}">
                            <div class="avatar-wrapper">
                                <img src="{{ participant.get_avatar_url }}" 
                                     alt="{{ participant.display_name }}" 
                                     class="participant-avatar">
                                <div class="avatar-status online"></div>
                            </div>
                            <div class="participant-info">
                                <span class="participant-name" title="{{ participant.display_name }}">
                                    {{ participant.display_name[:15] + '...' if participant.display_name|length > 15 else participant.display_name }}
                                </span>
                                {% if participant.id == room.creator_id %}
                                <span class="creator-badge">CREATOR</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            
            <!-- Offline Users Section -->
            <div class="participants-section offline-section">
                <div class="participants-section-header">
                    OFFLINE — <span>{{ offline_count }}</span>
                </div>
                <div class="offline-users">
                    {% for participant in participants %}
                        {% if not participant.is_online %}
                        <div class="participant" data-user-id="{{ participant.id }}">
                            <div class="avatar-wrapper">
                                <img src="{{ participant.get_avatar_url }}" 
                                     alt="{{ participant.display_name }}" 
                                     class="participant-avatar">
                                <div class="avatar-status offline"></div>
                            </div>
                            <div class="participant-info">
                                <span class="participant-name" title="{{ participant.display_name }}">
                                    {{ participant.display_name[:15] + '...' if participant.display_name|length > 15 else participant.display_name }}
                                </span>
                                {% if participant.id == room.creator_id %}
                                <span class="creator-badge">CREATOR</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="imageModal" class="image-modal" style="display: none;">
    <div class="modal-content">
        <img id="modalImage" src="" alt="Zoomed image">
        <button class="close-modal">&times;</button>
        <div class="zoom-controls">
            <button class="zoom-btn zoom-in">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="zoom-btn zoom-out">
                <i class="fas fa-search-minus"></i>
            </button>
        </div>
    </div>
</div>

<script type="text/javascript">
// Initialize socket connection when DOM is ready
let socket;
let currentRoom = {{ room.id }};

// Add scroll to bottom function at the top level
function scrollToBottom(smooth = true) {
    const messagesContainer = document.querySelector('.messages-list');
    if (messagesContainer) {
        const scrollOptions = smooth ? { behavior: 'smooth' } : undefined;
        messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            ...scrollOptions
        });
    }
}

// Add this helper function at the top of your script
function formatMessageTime(timestamp) {
    // Convert the timestamp to a Date object
    const date = new Date(timestamp);
    if (isNaN(date.getTime())) {
        console.error('Invalid timestamp:', timestamp);
        return timestamp;
    }
    
    // Add 7 hours for GMT+7
    const gmt7Date = new Date(date.getTime() + (7 * 60 * 60 * 1000));
    
    const now = new Date();
    const gmt7Now = new Date(now.getTime() + (7 * 60 * 60 * 1000));
    const yesterday = new Date(gmt7Now);
    yesterday.setDate(yesterday.getDate() - 1);
    
    // Format time in GMT+7
    const timeStr = gmt7Date.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false,
        timeZone: 'UTC'  // Use UTC to avoid browser timezone conversion
    });
    
    // Check if same day using GMT+7 dates
    if (gmt7Date.toDateString() === gmt7Now.toDateString()) {
        return `Today at ${timeStr}`;
    }
    
    if (gmt7Date.toDateString() === yesterday.toDateString()) {
        return `Yesterday at ${timeStr}`;
    }
    
    // Otherwise show full date in GMT+7
    const dateStr = gmt7Date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: '2-digit',
        timeZone: 'UTC'  // Use UTC to avoid browser timezone conversion
    });
    
    return `${dateStr} ${timeStr}`;
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize socket connection
    socket = io();

    const messagesContainer = document.querySelector('.messages-list');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.querySelector('.message-input-buttons [title="Send"]');

    // Send message on button click or Enter key
    function sendMessage() {
        const emojioneArea = $('#messageInput').data('emojioneArea');
        const message = emojioneArea ? emojioneArea.getText().trim() : messageInput.value.trim();
        
        if (message) {
            socket.emit('message', {
                message: message,
                room: currentRoom
            });
            
            // Clear input properly
            if (emojioneArea) {
                emojioneArea.setText('');
                emojioneArea.editor.empty();
            } else {
                messageInput.value = '';
            }
            // Force scroll to bottom after sending
            scrollToBottom(true);
        }
    }

    sendButton.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Handle new messages
    socket.on('new_message', function(data) {
        // Make sure we have all required data
        if (!data || !data.id || !data.user) {
            console.error('Invalid message data received:', data);
            return;
        }

        // Create message HTML with proper escaping
        const messageHtml = `
            <div class="message" data-message-id="${data.id}">
                <div class="avatar-wrapper">
                    <img src="${data.user.get_avatar_url || data.user.avatar_url}" 
                         class="message-avatar" 
                         alt="${data.user.display_name}">
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${data.user.display_name}</span>
                        <span class="message-time">${formatMessageTime(data.created_at)}</span>
                        ${data.edited ? '<span class="edited-indicator">(edited)</span>' : ''}
                    </div>
                    <div class="message-text">${data.content}</div>
                    ${data.file_url ? `
                        <div class="message-attachment">
                            ${data.file_url.match(/\.(jpg|jpeg|png|gif)$/i) ? `
                                <div style="background-color: #2b2d31; padding: 8px; border-radius: 8px;">
                                    <img src="${data.file_url}" 
                                         alt="${data.file_name}" 
                                         style="max-width: 300px; border-radius: 4px; display: block;" 
                                         class="zoomable-image">
                                    <div style="margin-top: 8px; font-size: 0.9em; color: #b9bbbe;">
                                        ${data.file_name}
                                    </div>
                                </div>
                            ` : `
                                <a href="${data.file_url}" target="_blank" download>
                                    <i class="fas fa-file"></i> ${data.file_name}
                                </a>
                            `}
                        </div>
                    ` : ''}
                    <div class="message-reactions"></div>
                </div>
                <div class="message-hover-controls">
                    <div class="reactions-group">
                        <div class="quick-reactions">
                            <button class="btn-icon reaction-btn" data-emoji="👍" data-message-id="${data.id}" title="Like">👍</button>
                            <button class="btn-icon reaction-btn" data-emoji="❤️" data-message-id="${data.id}" title="Heart">❤️</button>
                            <button class="btn-icon reaction-btn" data-emoji="😄" data-message-id="${data.id}" title="Smile">😄</button>
                            <button class="btn-icon reaction-btn" data-emoji="" data-message-id="${data.id}" title="Wow">😮</button>
                            <button class="btn-icon reaction-btn" data-emoji="😢" data-message-id="${data.id}" title="Sad">😢</button>
                            <button class="btn-icon add-reaction" data-message-id="${data.id}" title="Add Reaction">
                                <i class="fas fa-plus"></i>
                            </button>
                            ${data.user.id === {{ current_user.id }} || {{ current_user.is_admin|tojson }} ? `
                            <div class="reaction-separator"></div>
                            <button class="btn-icon edit-message" title="Edit">
                                <i class="fas fa-pencil"></i>
                            </button>
                            <button class="btn-icon delete-message" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                        <div class="emoji-picker" style="display: none;">
                            <div class="emoji-picker-content">
                                <button class="emoji-option" data-emoji="😀">😀</button>
                                <button class="emoji-option" data-emoji="😂">😃</button>
                                <button class="emoji-option" data-emoji="😄">😄</button>
                                <button class="emoji-option" data-emoji="😁">😁</button>
                                <button class="emoji-option" data-emoji="😅">😅</button>
                                <button class="emoji-option" data-emoji="😂">😂</button>
                                <button class="emoji-option" data-emoji="🤣">🤣</button>
                                <button class="emoji-option" data-emoji="😊">😊</button>
                                <button class="emoji-option" data-emoji="🥰">🥰</button>
                                <button class="emoji-option" data-emoji="😎">😍</button>
                                <button class="emoji-option" data-emoji="🤩">🤩</button>
                                <button class="emoji-option" data-emoji="😘">😘</button>
                                <button class="emoji-option" data-emoji="💕">💕</button>
                                <button class="emoji-option" data-emoji="💖">💖</button>
                                <button class="emoji-option" data-emoji="😎">😎</button>
                                <button class="emoji-option" data-emoji="🤠">🤠</button>
                                <button class="emoji-option" data-emoji="😏">😏</button>
                                <button class="emoji-option" data-emoji="😌">😌</button>
                                <button class="emoji-option" data-emoji="🤪">🤪</button>
                                <button class="emoji-option" data-emoji="😜">😜</button>
                                <button class="emoji-option" data-emoji="🤓">🤓</button>
                                <button class="emoji-option" data-emoji="🥳">🥳</button>
                                <button class="emoji-option" data-emoji="🤔">🤔</button>
                                <button class="emoji-option" data-emoji="🤨">🤨</button>
                                <button class="emoji-option" data-emoji="😐">😐</button>
                                <button class="emoji-option" data-emoji="😑">😑</button>
                                <button class="emoji-option" data-emoji="👋">👋</button>
                                <button class="emoji-option" data-emoji="🙌">🙌</button>
                                <button class="emoji-option" data-emoji="👏">👏</button>
                                <button class="emoji-option" data-emoji="🎉">🎉</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add message to container and scroll
        try {
            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            const newMessage = messagesContainer.lastElementChild;
            updateMessageTextSize(newMessage);
            scrollToBottom(true);
        } catch (error) {
            console.error('Error displaying message:', error);
        }
    });

    // Handle reaction button clicks
    document.addEventListener('click', function(e) {
        const reactionBtn = e.target.closest('.reaction-btn');
        if (reactionBtn) {
            const messageId = reactionBtn.dataset.messageId;
            const emoji = reactionBtn.dataset.emoji;
            
            socket.emit('add_reaction', {
                message_id: messageId,
                emoji: emoji,
                room: currentRoom
            });
        }
    });

    // Handle reaction updates from server
    socket.on('reaction_updated', function(data) {
        const messageEl = document.querySelector(`.message[data-message-id="${data.message_id}"]`);
        if (messageEl) {
            const reactionsEl = messageEl.querySelector('.message-reactions');
            if (data.reactions && Object.keys(data.reactions).length > 0) {
                const reactionsHtml = `
                    <div class="active-reactions">
                        ${Object.entries(data.reactions).map(([emoji, count]) => `
                            <button class="reaction-count" data-emoji="${emoji}">
                                ${emoji} ${count}
                            </button>
                        `).join('')}
                    </div>
                `;
                reactionsEl.innerHTML = reactionsHtml;
            } else {
                reactionsEl.innerHTML = '';
            }
        }
    });

    // Join room when page loads
    socket.emit('join', { room: currentRoom });

    // Handle socket disconnection
    socket.on('disconnect', function() {
        socket.emit('leave', { room: currentRoom });
    });

    // Handle socket reconnection
    socket.on('connect', function() {
        if (document.visibilityState === 'visible') {
            socket.emit('join', { room: currentRoom });
        }
    });

    // Handle add reaction button clicks
    document.addEventListener('click', function(e) {
        const addReactionBtn = e.target.closest('.add-reaction');
        if (addReactionBtn) {
            const messageEl = addReactionBtn.closest('.message');
            const emojiPicker = messageEl.querySelector('.emoji-picker');
            // Close all other emoji pickers first
            document.querySelectorAll('.emoji-picker').forEach(picker => {
                if (picker !== emojiPicker) picker.style.display = 'none';
            });
            // Toggle current emoji picker
            emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
        }
        
        const emojiOption = e.target.closest('.emoji-option');
        if (emojiOption) {
            const messageEl = emojiOption.closest('.message');
            const messageId = messageEl.dataset.messageId;
            const emoji = emojiOption.dataset.emoji;
            
            socket.emit('add_reaction', {
                message_id: messageId,
                emoji: emoji,
                room: currentRoom
            });
            
            // Hide the emoji picker after selection
            emojiOption.closest('.emoji-picker').style.display = 'none';
        }
    });

    // Close emoji picker when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.reactions-group')) {
            document.querySelectorAll('.emoji-picker').forEach(picker => {
                picker.style.display = 'none';
            });
        }
    });

    // Initialize EmojioneArea with updated options
    $(messageInput).emojioneArea({
        pickerPosition: "top",
        tonesStyle: "bullet",
        inline: true,
        hidePickerOnBlur: false,
        search: true,
        shortnames: true,
        saveEmojisAs: "unicode",
        buttonTitle: "Use the TAB key to insert emoji faster",
        recentEmojis: true,
        filtersPosition: "bottom",
        searchPosition: "bottom",
        button: false,
        events: {
            ready: function() {
                this.editor[0].focus();
                scrollToBottom(false);
            },
            keydown: function(editor, event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    const message = this.getText().trim();
                    if (message) {
                        socket.emit('message', {
                            message: message,
                            room: currentRoom
                        });
                        this.setText('');
                        scrollToBottom(true);
                    }
                }
            }
        }
    });

    // Handle custom emoji button click
    document.querySelector('.custom-emoji-button').addEventListener('click', function(e) {
        e.stopPropagation();
        const emojioneArea = $('#messageInput').data('emojioneArea');
        if (emojioneArea.picker.is(":hidden")) {
            emojioneArea.showPicker();
        } else {
            emojioneArea.hidePicker();
        }
    });

    // Close emoji picker when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.emojionearea-picker') && 
            !e.target.closest('.custom-emoji-button')) {
            const emojioneArea = $('#messageInput').data('emojioneArea');
            if (emojioneArea.picker.is(":visible")) {
                emojioneArea.hidePicker();
            }
        }
    });

    // File upload handling
    const fileInput = document.getElementById('fileInput');
    const attachButton = document.getElementById('attachButton');
    const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB in bytes
    
    // Trigger file input when attach button is clicked
    attachButton.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Handle file selection
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Check file size
        if (file.size > MAX_FILE_SIZE) {
            alert('File size must be less than 100MB');
            fileInput.value = '';
            return;
        }
        
        // Get file extension
        const fileExt = file.name.split('.').pop().toLowerCase();
        
        // Define allowed extensions
        const allowedExtensions = [
            'jpg', 'jpeg', 'png', 'gif',
            'pdf', 'doc', 'docx',
            'zip', 'rar'
        ];
        
        if (!allowedExtensions.includes(fileExt)) {
            alert('Invalid file type. Allowed types: Images (JPG, PNG, GIF), Documents (PDF, DOC, DOCX), Archives (ZIP, RAR)');
            fileInput.value = '';
            return;
        }
        
        // Create FormData and append file
        const formData = new FormData();
        formData.append('file', file);
        formData.append('room', currentRoom);
        
        try {
            // Upload file
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Upload failed');
            }
            
            const data = await response.json();
            
            // Emit message with file
            socket.emit('message', {
                message: '',
                file_url: data.file_url,
                file_name: data.file_name,
                room: currentRoom
            });
            
            // Clear file input
            fileInput.value = '';
            
        } catch (error) {
            console.error('Upload error:', error);
            alert('Failed to upload file. Please try again.');
            fileInput.value = '';
        }
    });

    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const closeBtn = document.querySelector('.close-modal');
    
    // Function to open modal
    function openImageModal(imgSrc) {
        modal.style.display = 'block';
        modalImg.src = imgSrc;
        modalImg.style.transform = 'scale(1)'; // Reset zoom
    }
    
    // Function to close modal
    function closeImageModal() {
        modal.style.display = 'none';
        modalImg.style.transform = 'scale(1)'; // Reset zoom
    }
    
    // Add click handlers for existing images
    document.addEventListener('click', function(e) {
        const img = e.target.closest('.message-attachment img');
        if (img) {
            openImageModal(img.src);
        }
    });
    
    // Close modal when clicking close button or outside
    closeBtn.onclick = closeImageModal;
    modal.onclick = function(e) {
        if (e.target === modal) {
            closeImageModal();
        }
    };
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'block') {
            closeImageModal();
        }
    });

    // Add zoom functionality
    let currentZoom = 1;
    
    function zoomImage(direction) {
        if (direction === 'in' && currentZoom < 3) {
            currentZoom += 0.5;
        } else if (direction === 'out' && currentZoom > 0.5) {
            currentZoom -= 0.5;
        }
        modalImg.style.transform = `scale(${currentZoom})`;
    }

    // Handle edit/delete buttons
    document.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.delete-message');
        const editBtn = e.target.closest('.edit-message');
        
        if (deleteBtn) {
            const messageEl = deleteBtn.closest('.message');
            const messageId = messageEl.dataset.messageId;
            
            if (confirm('Are you sure you want to delete this message?')) {
                fetch(`/chat/message/${messageId}/delete`, {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageEl.remove();
                    } else {
                        alert('Failed to delete message: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete message');
                });
            }
        }
        
        if (editBtn) {
            const messageEl = editBtn.closest('.message');
            // Check if message is already being edited
            if (messageEl.querySelector('.edit-container')) {
                return;
            }

            const messageId = messageEl.dataset.messageId;
            const contentEl = messageEl.querySelector('.message-text');
            const headerEl = messageEl.querySelector('.message-header');
            const currentContent = contentEl.textContent;
            
            // Create edit container
            const editContainer = document.createElement('div');
            editContainer.className = 'edit-container';
            
            // Create edit textarea
            const textarea = document.createElement('textarea');
            textarea.className = 'edit-textarea';
            textarea.value = currentContent;
            
            editContainer.appendChild(textarea);
            
            // Create actions container
            const actions = document.createElement('div');
            actions.className = 'edit-actions';
            actions.innerHTML = `
                <div class="edit-toolbar">
                    <button class="btn-icon emoji-button" title="Add Emoji">
                        <i class="far fa-smile"></i>
                    </button>
                    <span class="edit-hint" style="color: #b9bbbe; font-size: 0.8em; margin-left: 8px;">
                        Press Enter to save, Shift+Enter for new line
                    </span>
                </div>
                <div class="edit-buttons">
                    <button class="save-edit">Save</button>
                    <button class="cancel-edit">Cancel</button>
                </div>
            `;
            
            editContainer.appendChild(actions);
            
            // Replace content with edit form
            contentEl.style.display = 'none';
            contentEl.parentNode.insertBefore(editContainer, contentEl);
            
            // Function to handle save
            function saveEdit() {
                const emojioneArea = $(textarea).data('emojioneArea');
                const newContent = emojioneArea ? emojioneArea.getText().trim() : textarea.value.trim();
                
                if (newContent) {
                    fetch(`/chat/message/${messageId}/edit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ content: newContent })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            contentEl.textContent = newContent;
                            if (!headerEl.querySelector('.edited-indicator')) {
                                headerEl.insertAdjacentHTML('beforeend', 
                                    '<span class="edited-indicator">(edited)</span>'
                                );
                            }
                            contentEl.style.display = '';
                            editContainer.remove();
                            updateMessageTextSize(messageEl);
                        } else {
                            alert('Failed to edit message: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to edit message');
                    });
                }
            }

            // Initialize EmojioneArea
            $(textarea).emojioneArea({
                pickerPosition: "top",
                tonesStyle: "bullet",
                inline: false,
                hidePickerOnBlur: false,
                search: true,
                shortnames: true,
                saveEmojisAs: "unicode",
                buttonTitle: "Use the TAB key to insert emoji faster",
                recentEmojis: true,
                filtersPosition: "bottom",
                searchPosition: "bottom",
                button: false,
                events: {
                    keydown: function(editor, event) {
                        if (event.key === 'Enter' && !event.shiftKey) {
                            event.preventDefault();
                            saveEdit();
                        } else if (event.key === 'Escape') {
                            contentEl.style.display = '';
                            editContainer.remove();
                        }
                    }
                }
            });

            // Handle save/cancel buttons
            actions.addEventListener('click', function(e) {
                const target = e.target;
                
                if (target.closest('.emoji-button')) {
                    const emojioneArea = $(textarea).data('emojioneArea');
                    if (emojioneArea) {
                        if (emojioneArea.picker.is(":hidden")) {
                            emojioneArea.showPicker();
                        } else {
                            emojioneArea.hidePicker();
                        }
                    }
                    return;
                }
                
                if (target.classList.contains('cancel-edit')) {
                    contentEl.style.display = '';
                    editContainer.remove();
                    return;
                }
                
                if (target.classList.contains('save-edit')) {
                    saveEdit();
                }
            });
        }
    });

    // Move the emoji detection and size update functions outside the DOMContentLoaded event
    function isEmojiOnly(inputText) {
        const text = inputText.trim();
        const emojiRegex = /^(?:\p{Emoji}\uFE0F?\p{Emoji_Modifier}*\u200D*)+$/u;
        return text.length > 0 && emojiRegex.test(text) && !/[a-zA-Z0-9]/.test(text);
    }

    function updateMessageTextSize(messageEl) {
        const textEl = messageEl.querySelector('.message-text');
        if (textEl) {
            const content = textEl.textContent || textEl.innerText;
            const cleanContent = content.trim();
            console.log('Checking content:', cleanContent, 'isEmojiOnly:', isEmojiOnly(cleanContent));
            if (isEmojiOnly(cleanContent)) {
                textEl.classList.add('emoji-only');
                console.log('Added emoji-only class');
            } else {
                textEl.classList.remove('emoji-only');
                console.log('Removed emoji-only class');
            }
        }
    }

    // Process existing messages
    function initializeMessages() {
        document.querySelectorAll('.message').forEach(updateMessageTextSize);
    }

    // Run immediately and after a delay
    initializeMessages();
    setTimeout(initializeMessages, 1000);

    // Add observer for dynamic content changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.classList && node.classList.contains('message')) {
                    updateMessageTextSize(node);
                }
            });
        });
    });
    
    observer.observe(document.getElementById('messages'), {
        childList: true,
        subtree: true
    });

    // Add function to handle participant status changes
    function handleParticipantStatus(userId, isOnline) {
        const participant = document.querySelector(`.participant[data-user-id="${userId}"]`);
        if (participant) {
            const statusDot = participant.querySelector('.avatar-status');
            const currentSection = participant.parentElement;
            const targetSection = isOnline ? 
                document.querySelector('.online-users') : 
                document.querySelector('.offline-users');
            
            // Update status dot
            if (statusDot) {
                statusDot.className = `avatar-status ${isOnline ? 'online' : 'offline'}`;
            }
            
            // Move participant to correct section if needed
            if (currentSection !== targetSection) {
                targetSection.appendChild(participant);
            }
            
            // Update counts immediately
            const onlineCount = document.querySelectorAll('.online-users .participant').length;
            const offlineCount = document.querySelectorAll('.offline-users .participant').length;
            
            document.querySelector('.online-section .participants-section-header').textContent = 
                `ONLINE — ${onlineCount}`;
            document.querySelector('.offline-section .participants-section-header').textContent = 
                `OFFLINE — ${offlineCount}`;
            document.querySelector('.participants-header span').textContent = 
                onlineCount + offlineCount;
        }
    }

    // Update socket event handlers
    socket.on('user_status_changed', function(data) {
        handleParticipantStatus(data.user_id, data.is_online);
    });

    socket.on('initial_counts', function(data) {
        if (data.online !== undefined && data.offline !== undefined) {
            document.querySelector('.online-section .participants-section-header').textContent = 
                `ONLINE — ${data.online}`;
            document.querySelector('.offline-section .participants-section-header').textContent = 
                `OFFLINE — ${data.offline}`;
            document.querySelector('.participants-header span').textContent = 
                data.online + data.offline;
        }
    });

    // Update the visibility change handler
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            socket.emit('join', { room: currentRoom });
            socket.emit('get_participants', { room: currentRoom });
            scrollToBottom(false);
        }
    });

    // Add scroll after image loads
    document.addEventListener('load', function(e) {
        if (e.target.tagName === 'IMG' && e.target.closest('.message-attachment')) {
            scrollToBottom(true);
        }
    }, true);

    // Initial scroll to bottom without animation
    setTimeout(() => {
        scrollToBottom(false);
    }, 100);
});
</script>
{% endblock %} 